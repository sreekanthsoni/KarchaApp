<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
        
        <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->

        <link rel="stylesheet" type="text/css" href="styles/jquery.mobile-1.4.5.css"/>
        <link rel="stylesheet" type="text/css" href="styles/font-awesome.min.css"/>
        <link rel="stylesheet" type="text/css" href="styles/jqm-icon-pack-fa.css"/>
        <link rel="stylesheet" type="text/css" href="css/jtsage-datebox.min.css"/>
        <link rel="stylesheet" type="text/css" href="styles/custom.css"/>
        <link rel="stylesheet" href="css/themes/expense-theme.css" />
        <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
        <link rel="stylesheet" href="css/jquery.mobile.structure-1.4.5.min.css" />

        <script src="js/jquery.min.js" type="text/javascript"></script>
        <script src="js/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
        <script src="js/jquery.validate.min.js" type="text/javascript"></script>
        <script src="js/jtsage-datebox.min.js" type="text/javascript"></script>
        <script src="js/jquery.DatabaseObject.js" type="text/javascript"></script>
        <script src="js/jquery.LoginObject.js" type="text/javascript"></script>
        <script src="js/jquery.AjaxJSON.js" type="text/javascript"></script>
        <script src="js/jquery.GetData.js" type="text/javascript"></script>
        <script src="js/jquery.MainEvents.js" type="text/javascript"></script>

        <title>TRANSACTIONS PAGE</title>
    </head>
    <body>
        <style>
            .ui-input-search:after{
                background-image: none !important;
            }
            
            input{
                text-align: center !important;
            }
        </style>
        <div data-role="page" id="edit_transaction_page">
            <div data-role="header" data-position="fixed" >
                <h3 class="text-center">TRANSACTIONS PAGE</h3>
                <a href="#edit_menu" class="ui-btn ui-btn-corner-all ui-nodisc-icon  ui-btn-icon-notext ui-icon-bars">Menu</a>
                <a href="logout.html" class="ui-btn ui-btn-corner-all ui-nodisc-icon  ui-btn-icon-notext ui-icon-power" rel="external">Logout</a>
                <span data-name="welcome_user" class="text-center welcome_user"></span>
                <div data-role="navbar" style="border-top: 1px solid #132226;">
                    <ul>
                        <li><a href="#edit_transaction_page" class="ui-btn ui-btn-icon-top ui-icon-edit ui-nodisc-icon ui-btn-active" >Edit Trasaction</a></li>
                        <li><a href="#add_transaction_page" class="ui-btn ui-btn-icon-top ui-icon-plus ui-nodisc-icon"  rel="external">Add Trasaction</a></li>
                    </ul>
		</div><!-- /navbar -->
            </div>
            <div data-role="main" class="ui-content">
                <h4 id="error_edit_transaction" class="error text-center">&nbsp;</h4>
                <input type="date" data-role="datebox" class="text-center" name="select_date" required data-options='{"mode": "datebox", "useDialogForceFalse": true, "noAnimation": true, "overrideSetDateButtonLabel":"Select Date"}'/>
                <div id="edit_transactions_container" class="hide">
                    <h4 data-name="action_status_message" class="text-center error">&nbsp;</h4>
                    <table data-role="table" data-mode="columntoggle:hide" class="ui-responsive ui-shadow table-stroke" data-column-btn-text="HIDE COLUMNS" id="date_wise_transactions" style="border: 1px solid black;">
                        <thead>
                            <tr>
                                <th class="text-left">DESCRIPTION</th>
                                <th class="text-right">AMOUNT</th>
                                <th class="text-right">&nbsp;</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </div>
            <div data-role="footer" data-position="fixed" >
		<div data-role="navbar">
                    <ul>
                        <li><a href="home.html" class="ui-btn ui-btn-icon-top ui-icon-home" rel="external">Home</a></li>
                        <li><a href="spendings.html" class="ui-btn ui-btn-icon-top ui-icon-cloud-upload" rel="external">All Entries</a></li>
                        <li><a href="transactions.html" class="ui-btn ui-btn-icon-top ui-icon-file-text-o ui-btn-active" rel="external">New Entry</a></li>
                        <li><a href="categories.html" class="ui-btn ui-btn-icon-top ui-icon-bars"  rel="external">Accounts</a></li>
                        <!--<li><a href="settings.html" class="ui-btn ui-btn-icon-top ui-icon-gear"   rel="external">Settings</a></li>-->
                        <li><a href="summary.html" class="ui-btn ui-btn-icon-top ui-icon-bullets"   rel="external">Summary</a></li>
                    </ul>
		</div><!-- /navbar -->
            </div><!-- /footer -->
            <div data-role="panel" id="edit_menu" data-position="left" data-display="overlay" >
                <div class="ui-panel-inner">
                    <ul class=" ui-nodisc-icon ui-listview">
                        <li data-icon="home" class="ui-first-child">
                            <a href="home.html" class="ui-btn ui-btn-icon-right ui-icon-home ui-btn-active" rel="external">Home</a>
                        </li>
                        <li data-icon="bullets" class="ui-first-child">
                            <a href="summary.html" class="ui-btn ui-btn-icon-right ui-icon-bullets" rel="external">Summary</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div data-role="page" id="add_transaction_page">
            <div data-role="header" data-position="fixed" >
                <h3 class="text-center">TRANSACTIONS PAGE</h3>
                <a href="#menu" class="ui-btn ui-btn-corner-all ui-nodisc-icon  ui-btn-icon-notext ui-icon-bars">Menu</a>
                <a href="logout.html" class="ui-btn ui-btn-corner-all ui-nodisc-icon  ui-btn-icon-notext ui-icon-power" rel="external">Logout</a>
                <span data-name="welcome_user" class="text-center welcome_user"></span>
                <div data-role="navbar" style="border-top: 1px solid #132226;">
                    <ul>
                        <li><a href="#edit_transaction_page" class="ui-btn ui-btn-icon-top ui-icon-edit ui-nodisc-icon" >Edit Trasaction</a></li>
                        <li><a href="#add_transaction_page" class="ui-btn ui-btn-icon-top ui-icon-plus ui-nodisc-icon ui-btn-active"  rel="external">Add Trasaction</a></li>
                    </ul>
		</div><!-- /navbar -->
            </div>
            <div data-role="main" class="ui-content">
                <form name="add_transaction_form" id="add_transaction_form" method="post" onsubmit="return false;">
                    <h4 id="error_transaction" class="error text-center">&nbsp;</h4>
                    <fieldset data-role="controlgroup"  data-type="horizontal" class="text-center">
                        <input type="radio" name="radio-choice-t-6" id="radio-choice-t-6a" value="income">
                        <label for="radio-choice-t-6a">INCOME</label>
                        <input type="radio" name="radio-choice-t-6" id="radio-choice-t-6b" value="expense" checked="checked">
                        <label for="radio-choice-t-6b">EXPENSE</label>
                    </fieldset>
                    <h3 class="text-left">Transaction Details</h3>
                    <input type="date" data-role="datebox" class="text-center" name="select_date" required data-options='{"mode": "datebox", "useDialogForceFalse": true, "noAnimation": true, "overrideSetDateButtonLabel":"Select Date"}'/>
                    <input type="number" step="0.01" name="amount" id="amount" placeholder="AMOUNT" required class="text-center"/>
                    <div class="ui-filterable">
                        <input type="text" name="category" id="category" data-type="search" placeholder="CATEGORY" required class="text-center" data-selected_id=""/>
                    </div>
                    <ul data-role="listview" data-filter="true" data-inset="true" data-input="#category" id="category_list"></ul>
                    <input type="text" name="notes" id="notes" placeholder="NOTES" class="text-center"/>
                    <div class="ui-field-contain">
                        <button type="submit" data-inline="true" class="ui-btn ui-btn-corner-all " data-name="add_transaction" name="add_transaction_btn">ADD TRANSACTION</button>
                    </div>
                </form>
            </div>
            <div data-role="footer" data-position="fixed" >
		<div data-role="navbar">
                    <ul>
                        <li><a href="home.html" class="ui-btn ui-btn-icon-top ui-icon-home" rel="external">Home</a></li>
                        <li><a href="spendings.html" class="ui-btn ui-btn-icon-top ui-icon-cloud-upload" rel="external">All Entries</a></li>
                        <li><a href="transactions.html" class="ui-btn ui-btn-icon-top ui-icon-file-text-o ui-btn-active" rel="external">New Entry</a></li>
                        <li><a href="categories.html" class="ui-btn ui-btn-icon-top ui-icon-bars"  rel="external">Accounts</a></li>
                        <!--<li><a href="settings.html" class="ui-btn ui-btn-icon-top ui-icon-gear"   rel="external">Settings</a></li>-->
                        <li><a href="summary.html" class="ui-btn ui-btn-icon-top ui-icon-bullets"   rel="external">Summary</a></li>
                    </ul>
		</div><!-- /navbar -->
            </div><!-- /footer -->
            <div data-role="panel" id="menu" data-position="left" data-display="overlay" >
                <div class="ui-panel-inner">
                    <ul class=" ui-nodisc-icon ui-listview">
                        <li data-icon="home" class="ui-first-child">
                            <a href="home.html" class="ui-btn ui-btn-icon-right ui-icon-home ui-btn-active" rel="external">Home</a>
                        </li>
                        <li data-icon="bullets" class="ui-first-child">
                            <a href="summary.html" class="ui-btn ui-btn-icon-right ui-icon-bullets" rel="external">Summary</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <script type="text/javascript" src="cordova.js"></script>
        <script>
            $("input[name=select_date]",$("#edit_transaction_page")).bind('datebox', function (e, passed) { 
                if ( passed.method === 'set' ) {
                    $(this).val(passed.value);
                    LoadTransactionOnSelectedDate();
                }
            });
            
            var hovered = false;
            $("#category_list").bind("mouseover",function() {
                hovered = true;
            }).bind("mouseout",function() {
                hovered = false;
            });
            function TransactionEntrySaved(bSaved, sMessage){
                if(bSaved){
                    $("#error_transaction").html("TRANSACTION SAVED ....");
                    $("input[name=amount]",$("#add_transaction_form")).val("").focus();
                    $("input[name=category]",$("#add_transaction_form")).val("");
                    $("input[name=notes]",$("#add_transaction_form")).val("");
                    setTimeout(function(){
                        $("#error_transaction").html("&nbsp;");
                    },2000);
                }else{
                    $("#error_transaction").html(sMessage);
                }
            }
            
            $("#add_transaction_form").validate({
                messages: {
                    select_date : { required: "Select valid date"},
                    amount      : { required: "Should be a valid amount"},
                    category    : { required: "Please enter category"}
                },submitHandler: function(form){
                    $("#error_transaction").html("SAVING TRANSACTION ....");
                    var data = {
                        user_id     : oLoginObject.GetUserID(),
                        session_id  : oLoginObject.GetSessionID,
                        trans_type  : $("input[name=radio-choice-t-6]:checked",form).val(),
                        sel_date    : $("input[name=select_date]",form).val(),
                        amount      : $("input[name=amount]",form).val(),
                        category    : $("input[name=category]",form).val(),
                        category_id : $("input[name=category]",form).attr("data-selected_id"),
                        notes       : $("input[name=notes]",form).val()
                    };
                    var url = oLoginObject.GetHostName() + oGetData.URLToSaveTransactionEntry();
                    oGetData.SaveTransactionEntry(url,data, TransactionEntrySaved);
                }
            });

            $("#category").keyup(function(){
                $(this).attr("data-selected_id","0");
            });
            
            $("#category").blur(function() {
                if(!hovered) {
                    $("#category_list").children().addClass('ui-screen-hidden');
                }
                else {
                    $("#category_list").bind("mouseup",function() {
                        $("#category_list").children().addClass('ui-screen-hidden');
                    });
                }
            });
            $(document).on("click", "li", function () {
                var text = $(this).text();
                $("#category").val(text);
                $("#category").attr("data-selected_id",$(this).attr("data-id"));
                $("#category_list").children().addClass('ui-screen-hidden');
            });
            
            function CategoriesNames(bLoaded, sMessage, aCategoriesNames){
                var html = "";
                if(bLoaded){
                    $.each(aCategoriesNames,function(index,aCategoryInfo){
                       html += "<li data-id='"+aCategoryInfo["CATEGORY_ID"]+"'>"+aCategoryInfo["CATEGORY_NAME"]+"</li>"; 
                    });
                    $("#category_list").html(html);
                    $("#category_list").listview("refresh");
                    $("#category_list").trigger("updatelayout");
                }else{
                    $("#category_list").html(html);
                    $("#category_list").listview("refresh");
                    $("#category_list").children().addClass("ui-screen-hidden");
                    $("#category_list").trigger("updatelayout");
                    $("#category").attr("data-selected_id","0");
                }                
            }
            
            $("#category_list").on("filterablebeforefilter", function (e, data) {
                var $ul = $(this),
                $input = $(data.input),
                value = $input.val();
                $(this).attr("data-selected_id","0");
                var $ul = $("#category_list");
                if (value && value.length > 2) {
                    $ul.html("<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>");
                    $ul.listview("refresh");
                    var url = oLoginObject.GetHostName() + oGetData.URLToGetCategoriesName();
                    var data = {
                        user_id     : oLoginObject.GetUserID(),
                        session_id  : oLoginObject.GetSessionID(),
                        search_val  : value,
                        trans_type  : $("input[name=radio-choice-t-6]:checked").val()
                    };
                    oGetData.GetAllCategoriesName(url, data, CategoriesNames);
                }else{
                    $("#category_list").html("");
                    $("#category_list").listview("refresh");
                    $("#category_list").children().addClass("ui-screen-hidden");
                    $("#category_list").trigger("updatelayout");
                    $("#category").attr("data-selected_id","0");
                }
            });
            
            $("input[name=radio-choice-t-6]").change(function(){
                $("#category_list").html("");
                $("#category_list").listview("refresh");
                $("#category_list").children().addClass("ui-screen-hidden");
                $("#category_list").trigger("updatelayout");
                $("#category").attr("data-selected_id","0").val("");
            });
            
            function TransactionsOnDateLoaded(bLoaded, sMessage, aTransactions){
                if(bLoaded){
                    $("#error_edit_transaction").html("&nbsp;");
                    $("#date_wise_transactions tbody tr").remove();
                    $("div#edit_transactions_container").removeClass("hide");
                    var trRows = "";
                    $.each(aTransactions, function(index, aTransaction){
                        trRows += "<tr>"+
                                    "<td class='text-left'>"+aTransaction["TRANSACTION_FROM"]+" - "+aTransaction["TRANSACTION_TO"]+"<br/><small>"+aTransaction["TRANSACTION_DESCRIPTION"]+"</td>"+
                                    "<td class='text-right'>"+aTransaction["TRANSACTION_AMOUNT"]+"</td>"+
                                    "<td style='vertical-align: middle;'>"+
                                        "<a href='edit_transaction.html?transaction_id="+aTransaction.TRANSACTION_ID+"' rel='external' data-name='edit_order' class='ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-edit ui-btn-a ui-btn-icon-notext margin-4-0'>EDIT</a><br/>"+
                                        "<a href='javascript:void(0)' class='hide' data-name='delete_transaction' data-transaction_id='"+aTransaction.TRANSACTION_ID+"' class='ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-delete ui-btn-a ui-btn-icon-notext margin-4-0 dialog'>DELETE</a>"+
                                    "</td>"+
                                  "</tr>";
                    });
                    $("#date_wise_transactions tbody").append(trRows);
                }else{
                    $("#date_wise_transactions tbody tr").remove();
                    $("div#edit_transactions_container").addClass("hide");
                    $("#error_edit_transaction").html(sMessage);
                }
            }
            
            function LoadTransactionOnSelectedDate(){
                var data = {
                    user_id     : oLoginObject.GetUserID(),
                    session_id  : oLoginObject.GetSessionID(),
                    dDate       : $("input[name=select_date]",$("#edit_transaction_page")).val()
                };
                var url = oLoginObject.GetHostName() + oGetData.URLToLoadTransactionOnDate();
                oGetData.LoadTransactionsOnDate(url, data, TransactionsOnDateLoaded);
            }
            
            function DeviceLoaded(){
                if(!oLoginObject.CheckUserLoggedIn()){
                    window.location = "index.html";
                }

                var sUsername = oLoginObject.GetUsername();
                $("span[data-name=welcome_user]").html("WELCOME "+sUsername.toUpperCase());
                
                var pageid = $.mobile.activePage.attr("id");
                var sSelectedDate = oLoginObject.GetSelectedDate();
                $("input[name=select_date]",$("#"+pageid)).val(sSelectedDate);
                $('input[name=select_date]',$("#"+pageid)).datebox();
                if(pageid === "edit_transaction_page"){
                    var from_page = localStorage.getItem("from_page");
                    if(from_page !== undefined && from_page !== null && from_page === "edit_transaction_page"){
                        var selected_date = localStorage.getItem("selected_date");
                        if(selected_date !== undefined){
                            $("input[name=select_date]",$("#"+pageid)).val(selected_date);
                            $('input[name=select_date]',$("#"+pageid)).datebox();
                        }
                    }
                    LoadTransactionOnSelectedDate();
                    localStorage.removeItem("from_page");
                    localStorage.removeItem("selected_date");
                }
            }
        </script>
    </body>
</html>
